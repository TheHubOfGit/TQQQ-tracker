<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TQQQ Tracker</title>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/svg+xml" href="logo.svg">
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
</head>

<body>
    <div class="container">
        <header>
            <div class="header-top">
                <div class="ticker-group">
                    <img src="logo.svg" alt="Logo" style="width: 32px; height: 32px; margin-right: 10px;">
                    <span class="ticker">TQQQ</span>
                </div>
                <span class="name">ProShares UltraPro QQQ</span>
            </div>
            <div class="price-container">
                <span id="current-price" class="price">$0.00</span>
            </div>
            <div class="stats-container">
                <span id="price-change" class="change">+$0.00 (0.00%)</span>
                <span class="period">Today</span>
            </div>
        </header>

        <div class="chart-wrapper">
            <div id="chart"></div>
        </div>

        <div class="controls-row">
            <div class="time-filters">
                <button onclick="updatePeriod('3M')" id="btn-3M">3M</button>
                <button onclick="updatePeriod('6M')" id="btn-6M">6M</button>
                <button onclick="updatePeriod('1Y')" id="btn-1Y">1Y</button>
            </div>
            <div class="indicator-filters">
                <button onclick="setIndicator('SMA')" id="btn-SMA" class="active">SMA 50/100</button>
                <button onclick="setIndicator('EMA')" id="btn-EMA">EMA 9/12</button>
            </div>
        </div>

        <footer>
            <p>Updated: <span id="last-updated">--</span></p>
        </footer>
    </div>

    <script>
        let allData = {};
        let currentPeriod = '3M';
        let currentIndicator = 'SMA'; // 'SMA' or 'EMA'

        async function fetchData() {
            try {
                // Fetch from GitHub Raw to bypass Cloudflare build cache/limits for data
                const response = await fetch('https://raw.githubusercontent.com/TheHubOfGit/TQQQ-tracker/main/public/data.json');
                const data = await response.json();
                allData = data;

                // Initial render
                renderChart();

            } catch (error) {
                console.error('Error fetching data:', error);
                document.getElementById('last-updated').textContent = 'Error loading data';
            }
        }

        function updatePeriod(period) {
            currentPeriod = period;
            document.querySelectorAll('.time-filters button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`btn-${period}`).classList.add('active');
            renderChart();
        }

        function setIndicator(type) {
            currentIndicator = type;
            document.querySelectorAll('.indicator-filters button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`btn-${type}`).classList.add('active');
            renderChart();
        }

        function renderChart() {
            if (!allData.dates) return;

            // Determine slice count
            let sliceCount;
            switch (currentPeriod) {
                case '3M': sliceCount = 63; break;
                case '6M': sliceCount = 126; break;
                case '1Y': sliceCount = 252; break;
                default: sliceCount = 63;
            }

            // Slice data
            const dates = allData.dates.slice(-sliceCount);
            const prices = allData.prices.slice(-sliceCount);

            // Select Indicator Data
            let line1, line2, name1, name2;
            if (currentIndicator === 'SMA') {
                line1 = allData.sma50.slice(-sliceCount);
                line2 = allData.sma100.slice(-sliceCount);
                name1 = 'SMA 50 (Daily)';
                name2 = 'SMA 100 (Daily)';
            } else {
                line1 = allData.ema9.slice(-sliceCount);
                line2 = allData.ema12.slice(-sliceCount);
                name1 = 'EMA 9 (Daily)';
                name2 = 'EMA 12 (Daily)';
            }

            // Update Header Stats
            const currentPrice = prices[prices.length - 1];
            const startPrice = prices[0];
            const priceChange = currentPrice - startPrice;
            const percentChange = (priceChange / startPrice) * 100;
            const isPositive = priceChange >= 0;

            document.getElementById('current-price').textContent = `$${currentPrice.toFixed(2)}`;
            const sign = isPositive ? '+' : '';
            document.getElementById('price-change').textContent = `${sign}${priceChange.toFixed(2)} (${percentChange.toFixed(2)}%)`;
            document.querySelector('.period').textContent = currentPeriod === '1D' ? 'Today' : `Past ${currentPeriod}`;

            // Update Colors
            const themeColor = isPositive ? '#00c805' : '#ff5000';
            document.documentElement.style.setProperty('--accent', themeColor);
            document.getElementById('price-change').style.color = themeColor;

            // Detect Crossovers
            const crossovers = [];
            for (let i = 1; i < line1.length; i++) {
                if (line1[i] == null || line2[i] == null || line1[i - 1] == null || line2[i - 1] == null) continue;

                // Bullish: Line1 (Fast) crosses above Line2 (Slow)
                if (line1[i - 1] < line2[i - 1] && line1[i] > line2[i]) {
                    crossovers.push({ index: i, date: dates[i], type: 'bullish', color: '#00c805' });
                }
                // Bearish: Line2 (Slow) crosses above Line1 (Fast)
                else if (line1[i - 1] > line2[i - 1] && line1[i] < line2[i]) {
                    crossovers.push({ index: i, date: dates[i], type: 'bearish', color: '#ff5000' });
                }
            }

            // Chart Traces
            const trace1 = {
                x: dates,
                y: prices,
                type: 'scatter',
                mode: 'lines',
                name: 'TQQQ',
                line: { color: themeColor, width: 2 },
                hovertemplate: '$%{y:.2f}<extra></extra>'
            };

            const trace2 = {
                x: dates,
                y: line1,
                type: 'scatter',
                mode: 'lines',
                name: name1,
                line: { color: 'rgba(255, 215, 0, 0.6)', width: 1.5 }, // Gold
                hovertemplate: '$%{y:.2f}<extra></extra>'
            };

            const trace3 = {
                x: dates,
                y: line2,
                type: 'scatter',
                mode: 'lines',
                name: name2,
                line: { color: 'rgba(255, 255, 255, 0.4)', width: 1.5 }, // White/Grey
                hovertemplate: '$%{y:.2f}<extra></extra>'
            };

            // Shapes & Annotations
            const shapes = crossovers.map(cross => ({
                type: 'line',
                x0: cross.index,
                x1: cross.index,
                y0: 0,
                y1: 1,
                yref: 'paper',
                line: { color: cross.color, width: 2, dash: 'dot' }
            }));

            const annotations = crossovers.map(cross => ({
                x: cross.index,
                y: 1,
                yref: 'paper',
                text: cross.date,
                showarrow: false,
                font: { size: 9, color: cross.color },
                textangle: -90,
                xanchor: 'left',
                yanchor: 'bottom',
                xshift: 5
            }));

            const layout = {
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { family: 'DIN, Inter, sans-serif', color: '#fff' },
                xaxis: {
                    type: 'category',
                    showgrid: false,
                    zeroline: false,
                    showticklabels: false,
                    fixedrange: true
                },
                yaxis: {
                    showgrid: false,
                    zeroline: false,
                    showticklabels: false,
                    fixedrange: true
                },
                margin: { t: 20, r: 0, b: 20, l: 0 },
                showlegend: true,
                legend: { x: 0, y: 1, bgcolor: 'rgba(0,0,0,0)', font: { size: 10, color: 'rgba(255,255,255,0.5)' } },
                hovermode: 'x unified',
                hoverlabel: { bgcolor: '#1e1e1e', font: { color: '#fff' }, bordercolor: '#333' },
                transition: { duration: 500, easing: 'cubic-in-out' },
                shapes: shapes,
                annotations: annotations
            };

            const config = { responsive: true, displayModeBar: false, staticPlot: false };

            // If chart exists, use react for smooth update
            if (document.getElementById('chart').data) {
                Plotly.react('chart', [trace1, trace2, trace3], layout, config);
            } else {
                // First load
                Plotly.newPlot('chart', [trace1, trace2, trace3], layout, config);

                // Update timestamp
                const lastDate = allData.dates[allData.dates.length - 1];
                document.getElementById('last-updated').textContent = lastDate;
            }
        }

        // Check if current time is during market hours (9:30 AM - 4:00 PM ET, Mon-Fri)
        function isDuringMarketHours() {
            const now = new Date();
            const etTime = new Date(now.toLocaleString('en-US', { timeZone: 'America/New_York' }));
            const day = etTime.getDay(); // 0 = Sunday, 6 = Saturday
            const hours = etTime.getHours();
            const minutes = etTime.getMinutes();

            // Check if weekday (Mon-Fri)
            if (day === 0 || day === 6) return false;

            // Check if between 9:30 AM and 4:00 PM ET
            const currentMinutes = hours * 60 + minutes;
            const marketOpen = 9 * 60 + 30;  // 9:30 AM
            const marketClose = 16 * 60;      // 4:00 PM

            return currentMinutes >= marketOpen && currentMinutes < marketClose;
        }

        // Auto-refresh during market hours
        function setupAutoRefresh() {
            if (isDuringMarketHours()) {
                console.log('Market is open - auto-refresh enabled');
                setInterval(() => {
                    if (isDuringMarketHours()) {
                        console.log('Auto-refreshing data...');
                        fetchData();
                    }
                }, 15 * 60 * 1000); // 15 minutes
            } else {
                console.log('Market is closed - auto-refresh disabled');
            }
        }

        fetchData();
        setupAutoRefresh();

        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(reg => console.log('Service Worker registered'))
                    .catch(err => console.log('Service Worker registration failed:', err));
            });
        }
    </script>
</body>

</html>