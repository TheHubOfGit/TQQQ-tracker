<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TQQQ Tracker</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
</head>

<body>
    <div class="app-container">
        <header>
            <div class="ticker">TQQQ</div>
            <div class="company-name">ProShares UltraPro QQQ</div>
            <div class="price-container">
                <span id="current-price" class="price">$0.00</span>
            </div>
            <div class="stats-container">
                <span id="price-change" class="change">+$0.00 (0.00%)</span>
                <span class="period">Today</span>
            </div>
        </header>

        <div class="chart-wrapper">
            <div id="chart"></div>
        </div>

        <div class="time-filters">
            <button onclick="updatePeriod('3M')" id="btn-3M">3M</button>
            <button onclick="updatePeriod('6M')" id="btn-6M">6M</button>
            <button onclick="updatePeriod('1Y')" id="btn-1Y">1Y</button>
        </div>

        <footer>
            <p>Updated: <span id="last-updated">--</span></p>
        </footer>
    </div>

    <script>
        let allData = {};

        async function fetchData() {
            try {
                // Fetch from GitHub Raw to bypass Cloudflare build cache/limits for data
                const response = await fetch('https://raw.githubusercontent.com/TheHubOfGit/TQQQ-tracker/main/public/data.json');
                const data = await response.json();
                allData = data;

                // Initial render (default to 3M)
                updatePeriod('3M');

            } catch (error) {
                console.error('Error fetching data:', error);
                document.getElementById('last-updated').textContent = 'Error loading data';
            }
        }

        function updatePeriod(period) {
            // Update active button
            document.querySelectorAll('.time-filters button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`btn-${period}`).classList.add('active');

            // Determine slice count (approx trading days)
            let sliceCount;
            switch (period) {
                case '3M': sliceCount = 63; break;
                case '6M': sliceCount = 126; break;
                case '1Y': sliceCount = 252; break;
                default: sliceCount = 63;
            }

            // Slice data
            const dates = allData.dates.slice(-sliceCount);
            const prices = allData.prices.slice(-sliceCount);
            const sma50 = allData.sma50.slice(-sliceCount);
            const sma100 = allData.sma100.slice(-sliceCount);

            // Update Header Stats based on range
            const currentPrice = prices[prices.length - 1];
            const startPrice = prices[0];
            const priceChange = currentPrice - startPrice;
            const percentChange = (priceChange / startPrice) * 100;
            const isPositive = priceChange >= 0;

            document.getElementById('current-price').textContent = `$${currentPrice.toFixed(2)}`;
            const sign = isPositive ? '+' : '';
            document.getElementById('price-change').textContent = `${sign}${priceChange.toFixed(2)} (${percentChange.toFixed(2)}%)`;
            document.querySelector('.period').textContent = period === '1D' ? 'Today' : `Past ${period}`;

            // Update Colors
            const themeColor = isPositive ? '#00c805' : '#ff5000';
            document.documentElement.style.setProperty('--accent', themeColor);
            document.getElementById('price-change').style.color = themeColor;

            // Detect SMA crossovers in the current period
            const crossovers = [];
            for (let i = 1; i < sma50.length; i++) {
                // Skip if either SMA is null/undefined
                if (sma50[i] == null || sma100[i] == null || sma50[i - 1] == null || sma100[i - 1] == null) continue;

                // Bullish crossover: SMA50 crosses above SMA100
                if (sma50[i - 1] < sma100[i - 1] && sma50[i] > sma100[i]) {
                    crossovers.push({
                        index: i,
                        date: dates[i],
                        type: 'bullish',
                        color: '#00c805'
                    });
                }
                // Bearish crossover: SMA100 crosses above SMA50
                else if (sma50[i - 1] > sma100[i - 1] && sma50[i] < sma100[i]) {
                    crossovers.push({
                        index: i,
                        date: dates[i],
                        type: 'bearish',
                        color: '#ff5000'
                    });
                }
            }

            // Update Chart - use react for smooth, uniform animation
            const trace1 = {
                x: dates,
                y: prices,
                type: 'scatter',
                mode: 'lines',
                name: 'TQQQ',
                line: { color: themeColor, width: 2 },
                hovertemplate: '$%{y:.2f}<extra></extra>'
            };

            const trace2 = {
                x: dates,
                y: sma50,
                type: 'scatter',
                mode: 'lines',
                name: 'SMA 50 (Daily)',
                line: { color: 'rgba(255, 215, 0, 0.6)', width: 1.5 },
                hovertemplate: '$%{y:.2f}<extra></extra>'
            };

            const trace3 = {
                x: dates,
                y: sma100,
                type: 'scatter',
                mode: 'lines',
                name: 'SMA 100 (Daily)',
                line: { color: 'rgba(255, 255, 255, 0.4)', width: 1.5 },
                hovertemplate: '$%{y:.2f}<extra></extra>'
            };

            // Create shapes and annotations for crossovers
            const shapes = crossovers.map(cross => ({
                type: 'line',
                x0: cross.index,
                x1: cross.index,
                y0: 0,
                y1: 1,
                yref: 'paper',
                line: {
                    color: cross.color,
                    width: 2,
                    dash: 'dot'
                }
            }));

            const annotations = crossovers.map(cross => ({
                x: cross.index,
                y: 1,
                yref: 'paper',
                text: cross.date,
                showarrow: false,
                font: {
                    size: 9,
                    color: cross.color
                },
                textangle: -90,
                xanchor: 'left',
                yanchor: 'bottom',
                xshift: 5
            }));

            const layout = {
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { family: 'DIN, Inter, sans-serif', color: '#fff' },
                xaxis: {
                    type: 'category',
                    showgrid: false,
                    zeroline: false,
                    showticklabels: false,
                    fixedrange: true
                },
                yaxis: {
                    showgrid: false,
                    zeroline: false,
                    showticklabels: false,
                    fixedrange: true
                },
                margin: { t: 20, r: 0, b: 20, l: 0 },
                showlegend: true,
                legend: {
                    x: 0,
                    y: 1,
                    bgcolor: 'rgba(0,0,0,0)',
                    font: { size: 10, color: 'rgba(255,255,255,0.5)' }
                },
                hovermode: 'x unified',
                hoverlabel: {
                    bgcolor: '#1e1e1e',
                    font: { color: '#fff' },
                    bordercolor: '#333'
                },
                transition: {
                    duration: 500,
                    easing: 'cubic-in-out'
                },
                shapes: shapes,
                annotations: annotations
            };

            const config = {
                responsive: true,
                displayModeBar: false,
                staticPlot: false
            };

            // If chart exists, use react for smooth update
            if (document.getElementById('chart').data) {
                Plotly.react('chart', [trace1, trace2, trace3], layout, config);
            } else {
                // First load
                Plotly.newPlot('chart', [trace1, trace2, trace3], layout, config);

                // Update timestamp
                const lastDate = allData.dates[allData.dates.length - 1];
                document.getElementById('last-updated').textContent = lastDate;
            }
        }

        fetchData();
    </script>
</body>

</html>